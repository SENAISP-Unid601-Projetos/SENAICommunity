<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Chat Privado WebSocket</title>
</head>
<body>
    <h2>Chat Privado</h2>

    <label for="token">Token JWT:</label><br>
    <input type="text" id="token" size="100" />
    <button onclick="conectar()">Conectar</button><br><br>

    <p><strong>ID do Usuário Conectado:</strong> <span id="userId"></span></p>

    <label for="destinatario">ID do Destinatário:</label><br>
    <input type="number" id="destinatario" /><br><br>

    <label for="mensagem">Mensagem:</label><br>
    <input type="text" id="mensagem" size="50" />
    <button onclick="enviarMensagem()">Enviar</button><br><br>

    <h3>Mensagens Recebidas:</h3>
    <ul id="mensagens"></ul>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let usuarioId = null;

        function conectar() {
            const token = document.getElementById("token").value.trim();
            if (!token) {
                alert("Informe o token JWT!");
                return;
            }

            // Decodifica o token para pegar o userId (assumindo que está no "sub")
            const decoded = parseJwt(token);
            usuarioId = decoded.sub;
            document.getElementById("userId").textContent = usuarioId;

            // Passa o token na URL do SockJS para handshake no backend
            const socket = new SockJS(`http://localhost:8080/ws?token=${encodeURIComponent(token)}`);
            stompClient = Stomp.over(socket);

            document.cookie = "token=eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ0ZXVzw6NvQGdtYWlsLmNvbSIsInJvbGUiOiJST0xFX0FMVU5PIiwiaWQiOjIsImV4cCI6MTc1NzI2NTkwNn0.zVewa3I48cQDd8V6tOcRP-9Ng-6iafrQpXKjztfdHBd1-AlCkczrCyL_siS2tzViV2a9SQp1BQYlnywLRU4MAQ" + token + "; path=/";

            stompClient.connect(
                {}, // headers vazios, token já enviado na URL
                frame => {
                    console.log('Conectado:', frame);

                    // Assina fila privada do usuário (ajuste o destino conforme backend)
                    stompClient.subscribe(`/queue/usuario/${usuarioId}`, function (mensagem) {
                        const conteudo = JSON.parse(mensagem.body);
                        const item = document.createElement("li");
                        item.textContent = `${conteudo.remetenteUsername}: ${conteudo.conteudo}`;
                        document.getElementById("mensagens").appendChild(item);
                    });

                    console.log("Inscrito na fila do usuário ID:", usuarioId);
                },
                erro => {
                    console.error('Erro na conexão STOMP:', erro);
                    alert("Erro ao conectar. Verifique o token e tente novamente.");
                }
            );
        }

        function enviarMensagem() {
            const destinatarioId = document.getElementById("destinatario").value.trim();
            const conteudo = document.getElementById("mensagem").value.trim();

            if (!stompClient || !stompClient.connected) {
                alert("Você precisa se conectar primeiro!");
                return;
            }

            if (!destinatarioId || !conteudo) {
                alert("Preencha o destinatário e a mensagem.");
                return;
            }

            // Pega remetente do token armazenado (ou decodifica novamente)
            const token = document.getElementById("token").value.trim();
            const remetente = parseJwt(token).sub;

            // Envia para o endpoint do backend (ajuste '/app/mensagem' para o seu endpoint real)
            stompClient.send(`/app/mensagem`, {}, JSON.stringify({
                destinatarioId: destinatarioId,
                conteudo: conteudo,
                remetenteUsername: remetente
            }));

            document.getElementById("mensagem").value = "";
        }

        // Função para decodificar o payload JWT
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
    </script>
</body>
</html>
