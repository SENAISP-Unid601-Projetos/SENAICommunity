<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Página de Testes WebSocket</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: auto; max-width: 900px; padding: 2rem; background-color: #f8f9fa; color: #333; }
        .container { background-color: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        h2, h3, h4 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: .5rem; font-weight: bold; }
        input[type="text"], input[type="password"], input[type="number"], textarea, input[type="file"] { width: calc(100% - 22px); padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; vertical-align: middle;}
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        button.success { background-color: #28a745; }
        button.success:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #chat-window, #public-feed-window, #project-chat-window { height: 500px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-top: 1rem; background-color: #f9f9f9; border-radius: 4px; }
        .message, .post-container, .comment-container { position: relative; }
        .message-actions, .post-actions, .comment-actions { position: absolute; top: 5px; right: 5px; display: none; background-color: rgba(255,255,255,0.8); padding: 3px; border-radius: 5px;}
        .message:hover .message-actions, .post-container:hover .post-actions, .comment-container:hover .comment-actions { display: block; }
        .action-btn { font-size: 10px; padding: 2px 5px; margin: 0 2px; cursor: pointer; border-radius: 3px; }
        .message { margin-bottom: 8px; padding: 8px 12px; border-radius: 4px; max-width: 80%; word-wrap: break-word; }
        .message p { margin: 4px 0; }
        .message.sent { background-color: #d1e7dd; text-align: left; margin-left: auto; }
        .message.received { background-color: #e2e3e5; text-align: left; margin-right: auto; }
        #status { font-weight: bold; padding: 5px 10px; border-radius: 5px; display: inline-block; }
        #status.connected { color: #155724; background-color: #d4edda; }
        #status.disconnected { color: #721c24; background-color: #f8d7da; }
        #jwt-token { width: 100%; min-height: 60px; box-sizing: border-box; }
        .post-container { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fff; }
        .post-header { font-weight: bold; margin-bottom: 8px; color: #333; }
        .post-content { margin-bottom: 10px; white-space: pre-wrap; }
        .post-media img, .post-media video, .post-media audio { max-width: 100%; border-radius: 4px; margin-top: 10px; display: block;}
        .comments-section { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .comment-container { background-color: #f8f9fa; padding: 8px; border-radius: 5px; margin-bottom: 8px; border-left: 2px solid #ddd; padding-left: 10px; }
        .comment-header { font-size: 0.9em; color: #6c757d; }
        .comment-content { font-size: 0.95em; }
        .comment-form { display: flex; margin-top: 10px; }
        .comment-form input { flex-grow: 1; margin-right: 10px; }
        .comment-form button { font-size: 14px; padding: 5px 10px; }
        .comment-replies { margin-left: 25px; border-left: 2px solid #e9ecef; padding-left: 15px; }
        .reply-form { margin-left: 25px; margin-top: 5px; display: none; }
        .destacado { background-color: #fffbe6 !important; border-left-color: #ffc107 !important; }
        .action-btn.highlight { background-color: #ffc107; color: black; border-color: #ffc107; }
        .reply-info { font-size: 0.8em; color: #6c757d; margin-bottom: 4px; }
        .reply-info strong { color: #0056b3; }
        .highlight-badge { font-size: 0.8em; color: #856404; background-color: #fff3cd; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }

        .actions-bar { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .like-btn { background: none; border: 1px solid #ccc; color: #555; padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .like-btn.liked { background-color: #007bff; color: white; border-color: #007bff; font-weight: bold; }
        .like-count { font-size: 14px; color: #666; font-weight: bold; }
        .comment-actions-footer { display: flex; align-items: center; gap: 15px; margin-top: 10px; }

        .project-list-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .project-list-item:hover { background-color: #f0f0f0; }
        .project-list-item img { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; }
        .project-message-media img, .project-message-media video, .project-message-media audio { max-width: 100%; border-radius: 4px; margin-top: 5px; display: block; }
        #project-chat-window { height: 300px; }

        .convite-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .convite-info { font-size: 0.9em; }
        .convite-info strong { color: #0056b3; }
        .convite-actions button { font-size: 12px; padding: 5px 8px; }
        #convite-modal-list { max-height: 400px; overflow-y: auto; }
        .button-group { margin-bottom: 1.5rem; display: flex; flex-wrap: wrap; gap: 10px; }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        .message-sender-photo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            object-fit: cover;
            background-color: #eee;
        }

        .message p {
            margin-top: 0;
            padding-left: 38px;
        }
        .message.sent p {
             padding-left: 0;
        }
        .message.sent .message-header {
            flex-direction: row-reverse;
        }
        .message.sent .message-sender-photo {
            margin-right: 0;
            margin-left: 8px;
        }

        /* Estilos do Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #edit-post-media-list label, #edit-project-message-media-list label { display: inline-block; margin-right: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Etapa 1: Autenticação</h2>
    <div class="form-group">
        <label for="backend-url">URL do Backend:</label>
        <input type="text" id="backend-url" value="http://localhost:8080">
    </div>
    <div class="form-group">
        <label for="email">Email:</label>
        <input type="text" id="email" placeholder="seu.email@exemplo.com">
    </div>
    <div class="form-group">
        <label for="password">Senha:</label>
        <input type="password" id="password" placeholder="Sua senha">
    </div>
    <button onclick="login()">1. Login</button>
    <div class="form-group" style="margin-top: 1rem;">
        <label for="jwt-token">Token JWT:</label>
        <textarea id="jwt-token" readonly></textarea>
    </div>
</div>

<div class="container">
    <h2>Etapa 2: Conexão WebSocket</h2>
    <div class="form-group">
        <label for="my-user-id">Seu ID de Usuário:</label>
        <input type="number" id="my-user-id" readonly>
    </div>
    <button id="connect-btn" onclick="connect()" disabled>2. Conectar ao WebSocket</button>
    <button id="disconnect-btn" onclick="disconnect()" disabled>Desconectar</button>
    <p>Status: <span id="status" class="disconnected">Desconectado</span></p>
</div>

<div id="functionalities" style="display: none;">

    <div class="container">
        <h3>Etapa 3: Feed Público (Postagens)</h3>
        <div class="form-group">
            <label for="post-content">Nova Postagem:</label>
            <textarea id="post-content" placeholder="O que você está pensando?"></textarea>
        </div>
        <div class="form-group">
            <label for="post-files">Anexar Arquivos (Imagens, Vídeos, Áudios):</label>
            <input type="file" id="post-files" multiple>
        </div>
        <button onclick="createPost()">Enviar Postagem</button>
        <hr>
        <h4>Feed</h4>
        <div id="public-feed-window"></div>
    </div>

    <div class="container">
        <h3>Etapa 4: Projetos</h3>

        <div class="button-group">
            <button onclick="showReceivedInvites()">Ver Convites Recebidos</button>
            <button onclick="showSentInvites()">Ver Convites Enviados</button>
        </div>

        <h4>Criar Novo Projeto</h4>
        <div class="form-group">
            <label for="projeto-titulo">Título:</label>
            <input type="text" id="projeto-titulo" placeholder="Título do Projeto">
        </div>
        <div class="form-group">
            <label for="projeto-descricao">Descrição:</label>
            <textarea id="projeto-descricao" placeholder="Descreva seu projeto..."></textarea>
        </div>
        <div class="form-group" style="max-width: 200px;">
            <label for="projeto-max-membros">Max. Membros:</label>
            <input type="number" id="projeto-max-membros" value="10">
        </div>
        <div class="form-group">
            <input type="checkbox" id="projeto-privado" style="width: auto;">
            <label for="projeto-privado" style="display: inline-block; font-weight: normal;">Grupo Privado</label>
        </div>
        <div class="form-group">
            <label for="projeto-professor-ids">IDs Professores (separados por vírgula):</label>
            <input type="text" id="projeto-professor-ids" placeholder="1,2,3">
        </div>
        <div class="form-group">
            <label for="projeto-aluno-ids">IDs Alunos (separados por vírgula):</label>
            <input type="text" id="projeto-aluno-ids" placeholder="4,5,6">
        </div>
        <div class="form-group">
            <label for="projeto-foto">Foto do Projeto (Opcional):</label>
            <input type="file" id="projeto-foto">
        </div>
        <button onclick="createProject()">Criar Projeto</button>
        <hr style="margin: 2rem 0;">

        <h4>Lista de Projetos (Clique para abrir o chat)</h4>
        <div id="project-list-window" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9; border-radius: 4px;">
            </div>
        <input type="hidden" id="selected-project-id">
        <h4 style="margin-top: 2rem;">Chat do Projeto: <span id="selected-project-name" style="color: #333;">Nenhum selecionado</span></h4>

        <div id="project-chat-window">
            Selecione um projeto da lista acima.
        </div>
        <div class="form-group" style="margin-top: 1rem;">
            <label for="project-message-content">Sua Mensagem:</label>
            <input type="text" id="project-message-content" placeholder="Digite sua mensagem...">
        </div>
        <div class="form-group">
            <label for="project-message-files">Anexar Arquivos:</label>
            <input type="file" id="project-message-files" multiple>
        </div>
        <button id="project-send-btn" onclick="sendProjectMessage()" disabled>Enviar Mensagem</button>
    </div>


    <div class="container">
        <h3>Etapa 5: Chat Privado</h3>
        <div class="form-group">
            <label for="recipient-id">ID do Destinatário:</label>
            <input type="number" id="recipient-id" placeholder="Digite o ID e pressione Enter ou clique fora" onchange="fetchChatHistory()">
        </div>
        <div id="chat-window"></div>
        <div class="form-group" style="margin-top: 1rem;">
            <label for="message">Sua Mensagem:</label>
            <input type="text" id="message" placeholder="Digite sua mensagem...">
        </div>
        <button onclick="sendMessage()">Enviar Mensagem</button>
    </div>
</div>

<div id="editPostModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('editPostModal')">&times;</span>
        <h3>Editar Postagem</h3>
        <input type="hidden" id="edit-post-id">
        <div class="form-group">
            <label for="edit-post-content">Conteúdo:</label>
            <textarea id="edit-post-content"></textarea>
        </div>
        <div class="form-group">
            <label>Mídias Atuais (marque para remover):</label>
            <div id="edit-post-media-list"></div>
        </div>
        <div class="form-group">
            <label for="edit-post-files">Adicionar novos arquivos:</label>
            <input type="file" id="edit-post-files" multiple>
        </div>
        <button onclick="submitPostEdit()">Salvar Alterações</button>
    </div>
</div>

<div id="editMessageModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('editMessageModal')">&times;</span>
        <h3>Editar Mensagem Privada</h3>
        <input type="hidden" id="edit-message-id">
        <div class="form-group">
            <label for="edit-message-content">Conteúdo:</label>
            <textarea id="edit-message-content"></textarea>
        </div>
        <button onclick="submitMessageEdit()">Salvar Alterações</button>
    </div>
</div>

<div id="editCommentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('editCommentModal')">&times;</span>
        <h3>Editar Comentário</h3>
        <input type="hidden" id="edit-comment-id">
        <div class="form-group">
            <label for="edit-comment-content">Conteúdo:</label>
            <textarea id="edit-comment-content"></textarea>
        </div>
        <button onclick="submitCommentEdit()">Salvar Alterações</button>
    </div>
</div>

<div id="editProjectMessageModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('editProjectMessageModal')">&times;</span>
        <h3>Editar Mensagem do Projeto</h3>
        <input type="hidden" id="edit-project-message-id">
        <input type="hidden" id="edit-project-message-project-id">
        <div class="form-group">
            <label for="edit-project-message-content">Conteúdo:</label>
            <textarea id="edit-project-message-content"></textarea>
        </div>
        <div class="form-group">
            <label>Mídias Atuais (marque para remover):</label>
            <div id="edit-project-message-media-list"></div>
        </div>
        <div class="form-group">
            <label for="edit-project-message-files">Adicionar novos arquivos:</label>
            <input type="file" id="edit-project-message-files" multiple>
        </div>
        <button onclick="submitProjectMessageEdit()">Salvar Alterações</button>
    </div>
</div>

<div id="convitesModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('convitesModal')">&times;</span>
        <h3 id="convite-modal-title">Convites</h3>
        <div id="convite-modal-list">
            </div>
    </div>
</div>


<script>
    let stompClient = null;
    let jwtToken = null;
    const activeSubscriptions = {};
    let currentProjectSubscription = null;

    // --- FUNÇÕES DE AUTENTICAÇÃO E UTILITÁRIAS ---
    function getUserIdFromToken(token) {
        try {
            const payloadBase64 = token.split('.')[1];
            const decodedJson = atob(payloadBase64);
            const decodedPayload = JSON.parse(decodedJson);
            return decodedPayload.id;
        } catch (e) {
            console.error("Não foi possível decodificar o token.", e);
            return null;
        }
    }

    async function login() {
        const backendUrl = document.getElementById('backend-url').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            const response = await fetch(`${backendUrl}/autenticacao/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, senha: password })
            });
            if (!response.ok) throw new Error(`Falha no login: ${response.status}`);
            const data = await response.json();
            jwtToken = data.token;
            document.getElementById('jwt-token').value = jwtToken;
            document.getElementById('connect-btn').disabled = false;
            const userId = getUserIdFromToken(jwtToken);
            if (userId) document.getElementById('my-user-id').value = userId;
            alert("Login realizado com sucesso! Agora clique em 'Conectar'.");
        } catch (error) {
            console.error("Erro no login:", error);
            alert(error.message);
        }
    }

    // --- FUNÇÕES DE CONEXÃO E WEBSOCKET ---
    function connect() {
        if (!jwtToken) { alert("Faça o login primeiro."); return; }
        const backendUrl = document.getElementById('backend-url').value;
        const socket = new SockJS(`${backendUrl}/ws`);
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        const headers = { 'Authorization': 'Bearer ' + jwtToken };

        stompClient.connect(headers, function(frame) {
            console.log('CONECTADO COM SUCESSO');
            updateConnectionStatus(true);

            fetchPublicPosts();
            fetchProjects();

            stompClient.subscribe(`/user/queue/usuario`, function(message) {
                const payload = JSON.parse(message.body);
                if (payload.tipo === 'remocao') {
                    document.getElementById(`message-${payload.id}`)?.remove();
                } else {
                    const myUserId = document.getElementById('my-user-id').value;
                    const currentRecipientId = document.getElementById('recipient-id').value;
                    if ((String(payload.remetenteId) === myUserId && String(payload.destinatarioId) === currentRecipientId) ||
                        (String(payload.remetenteId) === currentRecipientId && String(payload.destinatarioId) === myUserId)) {
                        showMessage(payload);
                    }
                }
            });

            stompClient.subscribe('/topic/publico', function(message) {
                const payload = JSON.parse(message.body);
                const postElement = document.getElementById(`post-${payload.postagemId || payload.id}`);

                if (payload.tipo === 'remocao') {
                    postElement?.remove();
                } else if (payload.tipo === 'edicao') {
                    fetchAndReplacePost(payload.postagem.id);
                } else {
                    if(!postElement) showPublicPost(payload, true);
                }
            });
        }, function(error) {
            console.error('ERRO DE CONEXÃO:', error);
            updateConnectionStatus(false);
        });
    }

    function disconnect() {
        for (const topic in activeSubscriptions) {
            activeSubscriptions[topic].unsubscribe();
            delete activeSubscriptions[topic];
        }

        if (currentProjectSubscription) {
            currentProjectSubscription.unsubscribe();
            currentProjectSubscription = null;
        }

        if (stompClient !== null) { stompClient.disconnect(); }
        updateConnectionStatus(false);
        console.log("Desconectado");
    }

    function updateConnectionStatus(isConnected) {
        const statusEl = document.getElementById('status');
        const functionalitiesEl = document.getElementById('functionalities');
        if (isConnected) {
            statusEl.textContent = 'Conectado';
            statusEl.className = 'connected';
            document.getElementById('disconnect-btn').disabled = false;
            document.getElementById('connect-btn').disabled = true;
            functionalitiesEl.style.display = 'block';
        } else {
            statusEl.textContent = 'Desconectado';
            statusEl.className = 'disconnected';
            document.getElementById('disconnect-btn').disabled = true;
            document.getElementById('connect-btn').disabled = (jwtToken === null);
            functionalitiesEl.style.display = 'none';
        }
    }

    // --- FUNÇÕES DE POSTAGEM (Feed Público) ---
    async function fetchPublicPosts() {
        const feedWindow = document.getElementById('public-feed-window');
        feedWindow.innerHTML = '';
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/publico`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro: ${response.status}`);
            const posts = await response.json();
            posts.forEach(post => showPublicPost(post, false));
        } catch (error) {
            alert(error.message);
        }
    }

    async function createPost() {
        const backendUrl = document.getElementById('backend-url').value;
        const content = document.getElementById('post-content').value;
        const files = document.getElementById('post-files').files;
        if (!content && files.length === 0) { alert("A postagem precisa de conteúdo ou arquivos."); return; }
        const formData = new FormData();
        formData.append('postagem', new Blob([JSON.stringify({ conteudo: content })], { type: 'application/json' }));
        for (let i = 0; i < files.length; i++) {
            formData.append('arquivos', files[i]);
        }
        try {
            const response = await fetch(`${backendUrl}/postagem/upload-mensagem`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + jwtToken },
                body: formData
            });
            if (!response.ok) throw new Error(`Erro ao criar postagem: ${await response.text()}`);
            document.getElementById('post-content').value = '';
            document.getElementById('post-files').value = null;
        } catch (error) {
            alert(error.message);
        }
    }

    async function toggleLike(postagemId, comentarioId) {
        if (!jwtToken) {
            alert("Você precisa estar conectado para curtir.");
            return;
        }
        const backendUrl = document.getElementById('backend-url').value;
        const body = {};
        if (postagemId) body.postagemId = postagemId;
        if (comentarioId) body.comentarioId = comentarioId;

        try {
            const response = await fetch(`${backendUrl}/curtidas/toggle`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                throw new Error(`Erro ao processar curtida: ${await response.text()}`);
            }
        } catch (error) {
            console.error("Erro no toggleLike:", error);
            alert(error.message);
        }
    }

    function createPostElement(post) {
        const postElement = document.createElement('div');
        postElement.className = 'post-container';
        postElement.id = `post-${post.id}`;
        postElement.dataset.authorId = post.autorId;

        let mediaHtml = '<div class="post-media">';
        const urls = post.urlsMidia || [];
        urls.forEach(url => {
            if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { mediaHtml += `<img src="${url}">`; }
            else if (url.match(/\.(mp4|webm|ogg)$/i)) { mediaHtml += `<video controls src="${url}"></video>`; }
            else if (url.match(/\.(mp3|wav|m4a)$/i)) { mediaHtml += `<audio controls src="${url}"></audio>`; }
        });
        mediaHtml += '</div>';

        const dataFormatada = new Date(post.dataCriacao).toLocaleString('pt-BR');
        const myUserId = document.getElementById('my-user-id').value;
        let actionsHtml = (String(post.autorId) === myUserId) ? `
            <div class="post-actions">
                <button class="action-btn" onclick='openEditPostModal(${post.id}, ${JSON.stringify(urls)})'>Editar</button>
                <button class="action-btn danger" onclick="deletePost(${post.id})">Excluir</button>
            </div>` : '';

        const postActionsBar = `
            <div class="actions-bar">
                <button class="like-btn ${post.curtidoPeloUsuario ? 'liked' : ''}" onclick="toggleLike(${post.id}, null)">
                    ❤️ <span class="like-count">${post.totalCurtidas}</span>
                </button>
            </div>`;

        let commentsHtml = `
            <div class="comments-section">
                <h4>Comentários</h4>
                <div class="comments-list" id="comentarios-${post.id}">`;

        if(post.comentarios && post.comentarios.length > 0) {
            const rootComments = post.comentarios.filter(c => !c.parentId);

            const sortedComments = rootComments.sort((a, b) => {
                if (a.destacado !== b.destacado) {
                    return b.destacado - a.destacado;
                }
                return new Date(a.dataCriacao) - new Date(b.dataCriacao);
            });

            sortedComments.forEach(comment => {
                commentsHtml += renderCommentWithReplies(comment, post.autorId, post.comentarios);
            });
        }

        commentsHtml += `</div>
            <div class="comment-form">
                <input type="text" id="comment-input-${post.id}" placeholder="Adicione um comentário...">
                <button onclick="sendComment(${post.id}, null)">Enviar</button>
            </div>
        </div>`;

        postElement.innerHTML = `
            ${actionsHtml}
            <div class="post-header"><strong>${post.nomeAutor}</strong> - ${dataFormatada}</div>
            <div class="post-content" id="post-content-${post.id}">${post.conteudo}</div>
            ${mediaHtml}
            ${postActionsBar}
            ${commentsHtml}
        `;

        subscribeToComments(post.id);
        return postElement;
    }

    function showPublicPost(post, prepend) {
        const feedWindow = document.getElementById('public-feed-window');
        const postElement = createPostElement(post);
        if (prepend) {
            feedWindow.prepend(postElement);
        } else {
            feedWindow.appendChild(postElement);
        }
    }

    async function fetchAndReplacePost(postId) {
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/postagem/${postId}`, {
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) return;
            const updatedPost = await response.json();

            const oldPostElement = document.getElementById(`post-${postId}`);
            if (oldPostElement) {
                const newPostElement = createPostElement(updatedPost);
                oldPostElement.replaceWith(newPostElement);
            }
        } catch (e) {
            console.error("Falha ao recarregar post:", e);
        }
    }

    async function deletePost(postId) {
        if (!confirm('Tem certeza que deseja excluir esta postagem?')) return;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/postagem/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao excluir postagem: ${response.status}`);
        } catch (error) {
            alert(error.message);
        }
    }

    function openEditPostModal(postId, mediaUrls) {
        const postContent = document.getElementById(`post-content-${postId}`).innerText;
        document.getElementById('edit-post-id').value = postId;
        document.getElementById('edit-post-content').value = postContent;
        const mediaListDiv = document.getElementById('edit-post-media-list');
        mediaListDiv.innerHTML = '';
        if (mediaUrls && mediaUrls.length > 0) {
            mediaUrls.forEach(url => {
                const filename = url.substring(url.lastIndexOf('/') + 1);
                mediaListDiv.innerHTML += `
                    <div>
                        <input type="checkbox" id="remove-media-${filename}" name="urlsParaRemover" value="${url}">
                        <label for="remove-media-${filename}">${filename}</label>
                    </div>`;
            });
        } else {
            mediaListDiv.innerHTML = 'Nenhuma mídia anexada.';
        }
        openModal('editPostModal');
    }

    async function submitPostEdit() {
        const postId = document.getElementById('edit-post-id').value;
        const content = document.getElementById('edit-post-content').value;
        const newFiles = document.getElementById('edit-post-files').files;
        const urlsParaRemover = Array.from(document.querySelectorAll('#edit-post-media-list input:checked')).map(cb => cb.value);
        const formData = new FormData();

        // Agrupa dados não-arquivo em um objeto para o DTO
        const postagemData = {
            conteudo: content,
            urlsParaRemover: urlsParaRemover
        };
        // Adiciona como JSON Blob
        formData.append('postagem', new Blob([JSON.stringify(postagemData)], { type: 'application/json' }));

        // Adiciona novos arquivos
        for (let i = 0; i < newFiles.length; i++) {
            formData.append('arquivos', newFiles[i]);
        }
        try {
            // O endpoint no backend precisa ser ajustado para aceitar @RequestPart("postagem") PostagemEntradaDTO dto
            // e @RequestPart("arquivos") List<MultipartFile> novosArquivos
            const response = await fetch(`${document.getElementById('backend-url').value}/postagem/${postId}`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + jwtToken }, // Content-Type é definido automaticamente pelo browser para FormData
                body: formData
            });
            if (!response.ok) throw new Error(`Erro ao editar postagem: ${await response.text()}`);
            closeModal('editPostModal');
            document.getElementById('edit-post-files').value = null;
            // A atualização da UI deve vir via WebSocket ou recarregando a postagem
        } catch(error) {
            alert(error.message);
        }
    }


    // --- FUNÇÕES DE COMENTÁRIOS ---
    function subscribeToComments(postId) {
        if (stompClient && stompClient.connected) {
            const topic = `/topic/postagem/${postId}/comentarios`;
            if (activeSubscriptions[topic]) return;
            const subscription = stompClient.subscribe(topic, function(message) {
                fetchAndReplacePost(postId);
            });
            activeSubscriptions[topic] = subscription;
        }
    }

    function renderCommentWithReplies(comment, postAuthorId, allComments) {
        let commentHtml = renderComment(comment, postAuthorId);

        const replies = allComments
            .filter(reply => reply.parentId === comment.id)
            .sort((a, b) => {
                if (a.destacado !== b.destacado) {
                    return b.destacado - a.destacado;
                }
                return new Date(a.dataCriacao) - new Date(b.dataCriacao);
            });

        if (replies.length > 0) {
            commentHtml += `<div class="comment-replies">`;
            replies.forEach(reply => {
                commentHtml += renderCommentWithReplies(reply, postAuthorId, allComments);
            });
            commentHtml += `</div>`;
        }
        return commentHtml;
    }

    function renderComment(comment, postAuthorId) {
        const myUserId = document.getElementById('my-user-id').value;
        const dataFormatada = new Date(comment.dataCriacao).toLocaleString('pt-BR');
        let actionsHtml = '';
        const isAuthor = String(comment.autorId) === myUserId;
        const isPostOwner = String(postAuthorId) === myUserId;

        if (isAuthor || isPostOwner) {
            actionsHtml = `<div class="comment-actions">`;
            if (isAuthor) {
                actionsHtml += `<button class="action-btn" onclick='openEditCommentModal(${comment.id}, \`${comment.conteudo.replace(/`/g, '\\`')}\`)'>E</button>`;
            }
            if (isAuthor || isPostOwner) {
                actionsHtml += `<button class="action-btn danger" onclick="deleteComment(${comment.id})">X</button>`;
            }
            if (isPostOwner) {
                 actionsHtml += `<button class="action-btn highlight" onclick="highlightComment(${comment.id})">★</button>`;
            }
            actionsHtml += `</div>`;
        }

        let replyInfoHtml = '';
        if (comment.replyingToName) {
            replyInfoHtml = `<div class="reply-info">Respondendo a <strong>${comment.replyingToName}</strong></div>`;
        }

        let highlightBadge = '';
        if(comment.destacado){
            highlightBadge = `<span class="highlight-badge">Destacado pelo criador</span>`;
        }

        const commentActionsFooter = `
            <div class="comment-actions-footer">
                <button class="like-btn ${comment.curtidoPeloUsuario ? 'liked' : ''}" onclick="toggleLike(null, ${comment.id})">
                    ❤️ <span class="like-count">${comment.totalCurtidas}</span>
                </button>
                <button class="action-btn" style="font-size:12px; padding: 4px 8px;" onclick="toggleReplyForm(${comment.id})">Responder</button>
            </div>`;

        return `
            <div class="comment-container ${comment.destacado ? 'destacado' : ''}" id="comment-${comment.id}">
                ${actionsHtml}
                <div class="comment-header"><strong>${comment.nomeAutor}</strong> ${highlightBadge} - ${dataFormatada}</div>
                ${replyInfoHtml}
                <p class="comment-content">${comment.conteudo}</p>
                ${commentActionsFooter}
                <div class="reply-form" id="reply-form-${comment.id}">
                    <input type="text" id="reply-input-${comment.id}" placeholder="Escreva sua resposta...">
                    <button onclick="sendComment(${comment.postagemId}, ${comment.id})">Enviar</button>
                </div>
            </div>`;
    }

    function sendComment(postId, parentId) {
        const inputId = parentId ? `reply-input-${parentId}` : `comment-input-${postId}`;
        const input = document.getElementById(inputId);
        const content = input.value.trim();
        if(stompClient && content) {
            stompClient.send(`/app/postagem/${postId}/comentar`, {}, JSON.stringify({ conteudo: content, parentId: parentId || null }));
            input.value = '';
            if(parentId) toggleReplyForm(parentId);
        }
    }

    function toggleReplyForm(commentId) {
        const form = document.getElementById(`reply-form-${commentId}`);
        form.style.display = form.style.display === 'none' ? 'flex' : 'none';
    }

    async function highlightComment(commentId) {
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/comentarios/${commentId}/destacar`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao destacar comentário: ${await response.text()}`);
        } catch (error) {
            alert(error.message);
        }
    }

    function openEditCommentModal(commentId, currentContent) {
        document.getElementById('edit-comment-id').value = commentId;
        document.getElementById('edit-comment-content').value = currentContent;
        openModal('editCommentModal');
    }

    async function submitCommentEdit() {
        const commentId = document.getElementById('edit-comment-id').value;
        const content = document.getElementById('edit-comment-content').value;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/comentarios/${commentId}`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + jwtToken, 'Content-Type': 'application/json' },
                body: JSON.stringify(content)
            });
            if (!response.ok) throw new Error(`Erro ao editar comentário: ${await response.text()}`);
            closeModal('editCommentModal');
        } catch (error) {
            alert(error.message);
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('Tem certeza?')) return;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/comentarios/${commentId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao excluir comentário: ${response.status}`);
        } catch (error) {
            alert(error.message);
        }
    }

    // --- FUNÇÕES DO CHAT PRIVADO ---
    async function fetchChatHistory() {
        const myUserId = document.getElementById('my-user-id').value;
        const recipientId = document.getElementById('recipient-id').value;
        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = '';
        if (!myUserId || !recipientId) { return; }
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/privado/${myUserId}/${recipientId}`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao buscar histórico: ${response.status}`);
            const history = await response.json();
            history.forEach(message => showMessage(message));
        } catch (error) {
            alert(error.message);
        }
    }

    function sendMessage() {
        const recipientId = document.getElementById('recipient-id').value;
        const messageContent = document.getElementById('message').value;
        if (stompClient && messageContent && recipientId) {
            const chatMessage = {
                conteudo: messageContent,
                destinatarioId: parseInt(recipientId)
            };
            stompClient.send(`/app/privado/${recipientId}`, {}, JSON.stringify(chatMessage));
            document.getElementById('message').value = '';
        } else {
            alert("Verifique a conexão e preencha o ID do destinatário e a mensagem.");
        }
    }

    function showMessage(message) {
        const chatWindow = document.getElementById('chat-window');
        const existingElement = document.getElementById(`message-${message.id}`);
        if(existingElement) {
             existingElement.querySelector('p').innerText = message.conteudo;
             return;
        }
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.id = `message-${message.id}`;

        const myUserId = document.getElementById('my-user-id').value;
        const senderId = message.remetenteId || (message.remetente ? message.remetente.id : null);
        const senderName = message.nomeRemetente || (message.remetente ? message.remetente.nome : 'Desconhecido');

        let actionsHtml = '';
        if (String(senderId) === myUserId) {
            messageElement.classList.add('sent');
            actionsHtml = `
                <div class="message-actions">
                    <button class="action-btn" onclick='openEditMessageModal(${message.id}, \`${message.conteudo.replace(/`/g, '\\`')}\`)'>E</button>
                    <button class="action-btn danger" onclick="deletePrivateMessage(${message.id})">X</button>
                </div>`;
        } else {
            messageElement.classList.add('received');
        }
        messageElement.innerHTML = `
            ${actionsHtml}
            <strong>${senderName}:</strong>
            <p>${message.conteudo}</p>
        `;
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function deletePrivateMessage(messageId) {
        if(!confirm('Tem certeza?')) return;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/privado/${messageId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if(!response.ok) throw new Error(`Erro ao excluir: ${response.status}`);
        } catch(error) {
            alert(error.message);
        }
    }

    function openEditMessageModal(messageId, currentContent) {
        document.getElementById('edit-message-id').value = messageId;
        document.getElementById('edit-message-content').value = currentContent;
        openModal('editMessageModal');
    }

    async function submitMessageEdit() {
        const messageId = document.getElementById('edit-message-id').value;
        const content = document.getElementById('edit-message-content').value;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/privado/${messageId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken,
                    'Content-Type': 'application/json'
                 },
                body: JSON.stringify(content)
            });
            if(!response.ok) throw new Error(`Erro ao editar: ${await response.text()}`);
            closeModal('editMessageModal');
        } catch(error) {
            alert(error.message);
        }
    }


    // ##########################################
    // ###     FUNÇÕES DE PROJETO             ###
    // ##########################################

    async function fetchProjects() {
        const backendUrl = document.getElementById('backend-url').value;
        const listWindow = document.getElementById('project-list-window');
        listWindow.innerHTML = '';
        try {
            const response = await fetch(`${backendUrl}/projetos`, {
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao buscar projetos: ${response.status}`);
            const projects = await response.json();
            renderProjectList(projects);
        } catch (error) {
            console.error(error);
            listWindow.innerHTML = "Erro ao carregar projetos.";
        }
    }

    function renderProjectList(projects) {
        const listWindow = document.getElementById('project-list-window');
        const backendUrl = document.getElementById('backend-url').value;
        listWindow.innerHTML = '';
        if (projects.length === 0) {
            listWindow.innerHTML = "Nenhum projeto encontrado.";
            return;
        }
        projects.forEach(project => {
            const item = document.createElement('div');
            item.className = 'project-list-item';
            item.setAttribute('onclick', `selectProject(${project.id}, '${project.titulo.replace(/'/g, "\\'")}')`);

            let imgHtml = '';
            if (project.imagemUrl) {
                // Assumindo /projetos/imagens/ serve fotos de projeto
                const imageUrl = `${backendUrl}/projetos/imagens/${project.imagemUrl}`;
                imgHtml = `<img src="${imageUrl}" alt="Foto do Projeto">`;
            } else {
                imgHtml = `<div style="width:40px; height:40px; background-color:#ccc; border-radius:5px; text-align:center; line-height:40px; font-size:10px;">Sem Foto</div>`;
            }

            item.innerHTML = `${imgHtml} <div>${project.titulo}</div>`;
            listWindow.appendChild(item);
        });
    }

    async function createProject() {
        const backendUrl = document.getElementById('backend-url').value;
        const myUserId = document.getElementById('my-user-id').value;
        const formData = new FormData();

        const professorIds = document.getElementById('projeto-professor-ids').value.split(',')
                               .filter(id => id.trim() !== '').map(id => Number(id.trim()));
        const alunoIds = document.getElementById('projeto-aluno-ids').value.split(',')
                             .filter(id => id.trim() !== '').map(id => Number(id.trim()));

        formData.append('titulo', document.getElementById('projeto-titulo').value);
        formData.append('descricao', document.getElementById('projeto-descricao').value);
        formData.append('maxMembros', document.getElementById('projeto-max-membros').value);
        formData.append('grupoPrivado', document.getElementById('projeto-privado').checked);
        formData.append('autorId', myUserId);

        professorIds.forEach(id => formData.append('professorIds', id));
        alunoIds.forEach(id => formData.append('alunoIds', id));

        const foto = document.getElementById('projeto-foto').files[0];
        if (foto) {
            formData.append('foto', foto);
        }

        try {
            const response = await fetch(`${backendUrl}/projetos`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + jwtToken },
                body: formData
            });

            const responseData = await response.json();
            if (!response.ok) throw new Error(responseData.message || `Erro: ${response.status}`);

            alert(responseData.message || "Projeto criado com sucesso!");
            fetchProjects();

            document.getElementById('projeto-titulo').value = '';
            document.getElementById('projeto-descricao').value = '';
            document.getElementById('projeto-professor-ids').value = '';
            document.getElementById('projeto-aluno-ids').value = '';
            document.getElementById('projeto-foto').value = null;

        } catch (error) {
            alert(`Erro ao criar projeto: ${error.message}`);
        }
    }

    function selectProject(projectId, projectName) {
        document.getElementById('selected-project-id').value = projectId;
        document.getElementById('selected-project-name').textContent = projectName;
        document.getElementById('project-send-btn').disabled = false;

        document.getElementById('project-chat-window').innerHTML = '';

        fetchProjectChatHistory(projectId);
        subscribeToProjectChat(projectId);
    }

    function subscribeToProjectChat(projectId) {
        if (!stompClient || !stompClient.connected) return;

        if (currentProjectSubscription) {
            currentProjectSubscription.unsubscribe();
            console.log("Cancelou inscrição do projeto anterior.");
        }

        const topic = `/topic/projeto/${projectId}`;
        console.log(`Inscrevendo-se em: ${topic}`);
        currentProjectSubscription = stompClient.subscribe(topic, function(message) {
            const payload = JSON.parse(message.body);

            if (payload.tipo === 'remocao') {
                const el = document.getElementById(`project-message-${payload.id}`);
                if (el) el.remove();
            } else if (payload.tipo === 'edicao') {
                showProjectMessage(payload.mensagem, true);
            } else {
                showProjectMessage(payload, false);
            }
        });
    }

    async function fetchProjectChatHistory(projectId) {
        const chatWindow = document.getElementById('project-chat-window');
        chatWindow.innerHTML = 'Carregando histórico...';
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/projetos/${projectId}/chat/mensagens`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao buscar histórico: ${response.status}`);
            const history = await response.json();
            chatWindow.innerHTML = '';
            history.forEach(message => showProjectMessage(message, false));
        } catch (error) {
            alert(error.message);
            chatWindow.innerHTML = 'Erro ao carregar histórico.';
        }
    }

    async function sendProjectMessage() {
        const projectId = document.getElementById('selected-project-id').value;
        const content = document.getElementById('project-message-content').value;
        const files = document.getElementById('project-message-files').files;

        if (!projectId) { alert("Nenhum projeto selecionado."); return; }
        if (!content && files.length === 0) { alert("A mensagem precisa de conteúdo ou arquivos."); return; }

        const formData = new FormData();
        // Envia o conteúdo como parte separada (Spring lida bem com String)
        formData.append('conteudo', content);
        // Envia os arquivos como partes separadas
        for (let i = 0; i < files.length; i++) {
            formData.append('arquivos', files[i]);
        }

        try {
            // O controller backend está esperando @RequestPart("conteudo") String e @RequestPart("arquivos") List<MultipartFile>
            const response = await fetch(`${document.getElementById('backend-url').value}/projetos/${projectId}/chat/mensagens`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + jwtToken },
                body: formData
            });
            if (!response.ok) throw new Error(`Erro ao enviar mensagem: ${await response.text()}`);

            document.getElementById('project-message-content').value = '';
            document.getElementById('project-message-files').value = null;
        } catch (error) {
            alert(error.message);
        }
    }


    function showProjectMessage(message, isEdit = false) {
        const chatWindow = document.getElementById('project-chat-window');
        const existingElement = document.getElementById(`project-message-${message.id}`);

        if (existingElement && !isEdit) return;

        const messageElement = existingElement || document.createElement('div');
        messageElement.className = 'message';
        messageElement.id = `project-message-${message.id}`;

        const myUserId = document.getElementById('my-user-id').value;
        const backendUrl = document.getElementById('backend-url').value; // Pegar a URL base

        // --- Geração de Mídia (Anexos) ---
        let mediaHtml = '<div class="project-message-media">';
        const urls = message.urlsMidia || []; // Usando o campo correto do DTO
        urls.forEach(url => {
            // Assume que as URLs de mídia já são completas ou relativas corretamente
            if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { mediaHtml += `<img src="${url}">`; }
            else if (url.match(/\.(mp4|webm|ogg)$/i)) { mediaHtml += `<video controls src="${url}"></video>`; }
            else if (url.match(/\.(mp3|wav|m4a)$/i)) { mediaHtml += `<audio controls src="${url}"></audio>`; }
            else { mediaHtml += `<p><a href="${url}" target="_blank">Ver Anexo: ${url.substring(url.lastIndexOf('/') + 1)}</a></p>`}
        });
        mediaHtml += '</div>';

        // --- Geração de Ações (Editar/Excluir) ---
        let actionsHtml = '';
        if (String(message.autorId) === myUserId) { // Usando o campo correto do DTO
            messageElement.classList.add('sent');
            messageElement.classList.remove('received');

            const contentArg = `\`${message.conteudo.replace(/`/g, '\\`')}\``;
            const urlsArg = JSON.stringify(urls);
            actionsHtml = `
                <div class="message-actions">
                    <button class="action-btn" onclick='openEditProjectMessageModal(${message.id}, ${message.projetoId}, ${contentArg}, ${urlsArg})'>E</button>
                    <button class="action-btn danger" onclick="deleteProjectMessage(${message.id})">X</button>
                </div>`;
        } else {
            messageElement.classList.add('received');
            messageElement.classList.remove('sent');
        }

        // --- Geração de Nome e Foto ---
        const senderName = message.nomeAutor || 'Desconhecido';
        const relativePhotoPath = message.urlFotoAutor; // Ex: /api/arquivos/foto.jpg ou /images/default-avatar.png
        const fullPhotoUrl = backendUrl + relativePhotoPath;
        const defaultAvatarUrl = `${backendUrl}/images/default-avatar.png`;

        const photoHtml = `<img src="${fullPhotoUrl}" alt="${senderName}" class="message-sender-photo" onerror="this.onerror=null; this.src='${defaultAvatarUrl}';">`;

        // --- Monta o HTML final ---
        messageElement.innerHTML = `
            ${actionsHtml}
            <div class="message-header">
                ${photoHtml}
                <strong>${senderName}:</strong>
            </div>
            <p>${message.conteudo}</p>
            ${mediaHtml}
        `;

        if (!existingElement) {
            chatWindow.appendChild(messageElement);
        }

        if (!isEdit) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }


    async function deleteProjectMessage(messageId) {
        if(!confirm('Tem certeza que deseja excluir esta mensagem?')) return;
        const projectId = document.getElementById('selected-project-id').value;
        if (!projectId) return;

        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/projetos/${projectId}/chat/mensagens/${messageId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if(!response.ok) throw new Error(`Erro ao excluir: ${response.status}`);
            // WebSocket cuidará da remoção da UI
        } catch(error) {
            alert(error.message);
        }
    }

    function openEditProjectMessageModal(messageId, projectId, currentContent, mediaUrls) {
        document.getElementById('edit-project-message-id').value = messageId;
        document.getElementById('edit-project-message-project-id').value = projectId;
        document.getElementById('edit-project-message-content').value = currentContent;

        const mediaListDiv = document.getElementById('edit-project-message-media-list');
        mediaListDiv.innerHTML = '';
        if (mediaUrls && mediaUrls.length > 0) {
            mediaUrls.forEach(url => {
                const filename = url.substring(url.lastIndexOf('/') + 1);
                mediaListDiv.innerHTML += `
                    <div>
                        <input type="checkbox" id="remove-project-media-${filename}" name="urlsParaRemover" value="${url}">
                        <label for="remove-project-media-${filename}">${filename}</label>
                    </div>`;
            });
        } else {
            mediaListDiv.innerHTML = 'Nenhuma mídia anexada.';
        }

        openModal('editProjectMessageModal');
    }

    // --- FUNÇÃO submitProjectMessageEdit MODIFICADA ---
    async function submitProjectMessageEdit() {
        const messageId = document.getElementById('edit-project-message-id').value;
        const projectId = document.getElementById('edit-project-message-project-id').value;
        const content = document.getElementById('edit-project-message-content').value;
        const newFiles = document.getElementById('edit-project-message-files').files;
        const urlsParaRemover = Array.from(document.querySelectorAll('#edit-project-message-media-list input:checked')).map(cb => cb.value);

        const formData = new FormData();

        // 1. Cria o objeto DTO com os dados não-arquivo
        const dadosEdicao = {
            conteudo: content,
            urlsParaRemover: urlsParaRemover // Array de strings
        };

        // 2. Adiciona o DTO como um Blob JSON com a chave "dadosEdicao"
        formData.append('dadosEdicao', new Blob([JSON.stringify(dadosEdicao)], { type: 'application/json' }));

        // 3. Adiciona os novos arquivos (se houver) com a chave "novosArquivos"
        for (let i = 0; i < newFiles.length; i++) {
            formData.append('novosArquivos', newFiles[i]);
        }

        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/projetos/${projectId}/chat/mensagens/${messageId}`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + jwtToken }, // Content-Type é definido automaticamente pelo browser para FormData
                body: formData
            });

            if (!response.ok) {
                // Tenta ler a mensagem de erro do backend se a resposta for JSON
                let errorMsg = `Erro ao editar mensagem: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message || JSON.stringify(errorData);
                } catch(e) {
                    // Se não for JSON, lê como texto
                    errorMsg = await response.text();
                }
                 throw new Error(errorMsg);
            }

            closeModal('editProjectMessageModal');
            document.getElementById('edit-project-message-files').value = null;
            // A atualização da UI deve vir via WebSocket (o backend envia após salvar)
        } catch(error) {
            console.error("Erro detalhado:", error); // Loga o erro no console
            alert(error.message); // Exibe a mensagem de erro para o usuário
        }
    }
    // --- FIM DA FUNÇÃO MODIFICADA ---


    // ##########################################
    // ###     FUNÇÕES DE CONVITE             ###
    // ##########################################

    async function showReceivedInvites() {
        const listDiv = document.getElementById('convite-modal-list');
        listDiv.innerHTML = 'Carregando...';
        document.getElementById('convite-modal-title').innerText = 'Convites Recebidos (Pendentes)';
        openModal('convitesModal');

        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/projetos/convites/recebidos`, {
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro: ${response.status}`);

            const convites = await response.json();
            if (convites.length === 0) {
                listDiv.innerHTML = 'Nenhum convite recebido pendente.';
                return;
            }

            listDiv.innerHTML = '';
            convites.forEach(convite => {
                const data = new Date(convite.dataConvite).toLocaleString('pt-BR');
                listDiv.innerHTML += `
                    <div class="convite-item" id="convite-${convite.conviteId}">
                        <div class="convite-info">
                            Para o projeto: <strong>${convite.nomeProjeto}</strong><br>
                            Enviado por: <strong>${convite.convidadoPorNome}</strong><br>
                            Em: ${data}
                        </div>
                        <div class="convite-actions">
                            <button class="success" onclick="acceptInvite(${convite.conviteId})">Aceitar</button>
                            <button class="danger" onclick="rejectInvite(${convite.conviteId})">Recusar</button>
                        </div>
                    </div>
                `;
            });
        } catch (error) {
            listDiv.innerHTML = `Erro ao carregar convites: ${error.message}`;
        }
    }

    async function showSentInvites() {
        const listDiv = document.getElementById('convite-modal-list');
        listDiv.innerHTML = 'Carregando...';
        document.getElementById('convite-modal-title').innerText = 'Convites Enviados (Pendentes)';
        openModal('convitesModal');

        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/projetos/convites/enviados`, {
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro: ${response.status}`);

            const convites = await response.json();
            if (convites.length === 0) {
                listDiv.innerHTML = 'Nenhum convite enviado pendente.';
                return;
            }

            listDiv.innerHTML = '';
            convites.forEach(convite => {
                const data = new Date(convite.dataConvite).toLocaleString('pt-BR');
                listDiv.innerHTML += `
                    <div class="convite-item">
                        <div class="convite-info">
                            Para: <strong>${convite.convidadoNome}</strong> (${convite.convidadoEmail})<br>
                            Projeto: <strong>${convite.nomeProjeto}</strong><br>
                            Em: ${data}
                        </div>
                    </div>
                `;
            });
        } catch (error) {
            listDiv.innerHTML = `Erro ao carregar convites: ${error.message}`;
        }
    }

    async function acceptInvite(conviteId) {
        const myUserId = document.getElementById('my-user-id').value;
        const backendUrl = document.getElementById('backend-url').value;

        try {
            const response = await fetch(`${backendUrl}/projetos/convites/${conviteId}/aceitar?usuarioId=${myUserId}`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Erro ao aceitar');

            alert(data.message || 'Convite aceito!');
            document.getElementById(`convite-${conviteId}`).remove();
            fetchProjects(); // Recarrega a lista de projetos, pois agora você é membro
        } catch (error) {
            alert(error.message);
        }
    }

    async function rejectInvite(conviteId) {
        const myUserId = document.getElementById('my-user-id').value;
        const backendUrl = document.getElementById('backend-url').value;

        try {
            const response = await fetch(`${backendUrl}/projetos/convites/${conviteId}/recusar?usuarioId=${myUserId}`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Erro ao recusar');

            alert(data.message || 'Convite recusado.');
            document.getElementById(`convite-${conviteId}`).remove();
        } catch (error) {
            alert(error.message);
        }
    }


    // --- FUNÇÕES DO MODAL ---
    function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>
</body>
</html>